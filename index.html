<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Survey Tracker</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }

    .topbar {
      background: #2d3436; color: white; padding: 15px 30px;
      display: flex; justify-content: space-between; align-items: center;
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
    }
    .topbar a { color: #00cec9; margin-left: 15px; text-decoration: none; cursor: pointer; }

    .container { padding: 100px 20px 20px; max-width: 1200px; margin: auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }

    .day-card {
      background: white; padding: 15px; border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer;
    }

    .day-card:hover { background: #ecf0f1; }
    .date-title { font-weight: bold; margin-bottom: 10px; }

    .survey-links { display: none; margin-top: 10px; }
    .link-btn {
      background: #dfe6e9; padding: 8px 10px; border-radius: 5px;
      display: flex; justify-content: space-between; margin: 5px 0;
    }
    .link-btn.completed { background: #a0e8a0; text-decoration: line-through; }

    .link-btn button {
      background: #0984e3; color: white; border: none;
      padding: 5px 10px; border-radius: 5px; cursor: pointer;
    }

    .link-btn button:disabled { background: #636e72; }

    #loginPopup, #adminPanel {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000000cc; display: none; justify-content: center; align-items: center; z-index: 2000;
    }

    #loginPopup div, #adminPanel div {
      background: white; padding: 25px; border-radius: 10px; text-align: center;
      width: 300px;
    }

    input, button { font-size: 16px; margin: 8px 0; }

    .progress-bar-container {
      background: #ccc; border-radius: 20px; height: 24px; overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-bar-fill {
      height: 100%; background: #27ae60; width: 0%;
      text-align: center; color: white; line-height: 24px;
    }
  </style>
</head>
<body>

<div class="topbar">
  <div><strong id="usernameDisplay">Name:</strong> <span id="username">Guest</span></div>
  <div>
    <strong>Balance:</strong> â‚¹150
    <a onclick="logout()">Logout</a>
    <a onclick="openAdmin()">Admin</a>
  </div>
</div>

<!-- Login Popup -->
<div id="loginPopup">
  <div>
    <h3>Enter your name</h3>
    <input id="usernameInput" placeholder="Your name" />
    <br><button onclick="saveUsername()">Start</button>
  </div>
</div>

<!-- Admin Panel -->
<div id="adminPanel">
  <div>
    <h3>Admin Access</h3>
    <div id="adminLogin">
      <input type="password" id="adminPassword" placeholder="Enter Admin Password" />
      <br><button onclick="checkAdmin()">Login</button>
    </div>
    <div id="adminTools" style="display:none;">
      <input type="file" id="csvFile" accept=".csv" onchange="loadCSV(event)" />
      <p style="font-size:13px;">CSV format: Date,Survey Name,URL</p>
      <button onclick="closeAdmin()">Close</button>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="container">
  <div class="progress-bar-container">
    <div class="progress-bar-fill" id="progressBar">0%</div>
  </div>
  <div class="grid" id="calendarGrid"></div>
</div>

<script>
  const calendarGrid = document.getElementById("calendarGrid");
  const progressBar = document.getElementById("progressBar");
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const completedKey = `completed-surveys-${year}-${month}`;
  const surveyDataKey = `survey-data-${year}-${month}`;
  let completedSurveys = JSON.parse(localStorage.getItem(completedKey)) || {};
  let surveyMap = JSON.parse(localStorage.getItem(surveyDataKey)) || {};

  let userName = localStorage.getItem("username");
  function saveUsername() {
    const input = document.getElementById("usernameInput").value.trim();
    if (input) {
      localStorage.setItem("username", input);
      document.getElementById("username").innerText = input;
      document.getElementById("loginPopup").style.display = "none";
    }
  }
  function logout() {
    if (confirm("Logout?")) {
      localStorage.removeItem("username");
      location.reload();
    }
  }

  if (!userName) document.getElementById("loginPopup").style.display = "flex";
  else document.getElementById("username").innerText = userName;

  function openAdmin() {
    document.getElementById("adminPanel").style.display = "flex";
  }
  function closeAdmin() {
    document.getElementById("adminPanel").style.display = "none";
  }
  function checkAdmin() {
    const pass = document.getElementById("adminPassword").value;
    if (pass === "admin123") {
      document.getElementById("adminLogin").style.display = "none";
      document.getElementById("adminTools").style.display = "block";
    } else {
      alert("Incorrect password");
    }
  }

  function loadCSV(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      const lines = evt.target.result.split("\n");
      surveyMap = {};
      for (let line of lines) {
        const [date, name, url] = line.trim().split(",");
        if (!date || !name || !url) continue;
        if (!surveyMap[date]) surveyMap[date] = [];
        surveyMap[date].push({ name: name.trim(), url: url.trim() });
      }
      localStorage.setItem(surveyDataKey, JSON.stringify(surveyMap));
      alert("Surveys loaded!");
      location.reload();
    };
    reader.readAsText(file);
  }

  function saveCompleted(date, index) {
    if (!completedSurveys[date]) completedSurveys[date] = [];
    if (!completedSurveys[date].includes(index)) {
      completedSurveys[date].push(index);
      localStorage.setItem(completedKey, JSON.stringify(completedSurveys));
      updateProgress();
    }
  }

  function updateProgress() {
    let total = 0, done = 0;
    for (let date in surveyMap) {
      total += surveyMap[date].length;
      if (completedSurveys[date]) done += completedSurveys[date].length;
    }
    let percent = total ? Math.round((done / total) * 100) : 0;
    progressBar.style.width = percent + "%";
    progressBar.innerText = percent + "%";
  }

  function renderCalendar() {
    for (let dateStr in surveyMap) {
      const dateObj = new Date(dateStr);
      const card = document.createElement("div");
      card.className = "day-card";
      const title = document.createElement("div");
      title.className = "date-title";
      title.innerText = dateObj.toDateString();
      const linksContainer = document.createElement("div");
      linksContainer.className = "survey-links";

      surveyMap[dateStr].forEach((s, i) => {
        const row = document.createElement("div");
        row.className = "link-btn";
        const span = document.createElement("span");
        span.innerText = s.name;
        const btn = document.createElement("button");
        btn.innerText = "Open";

        if (completedSurveys[dateStr] && completedSurveys[dateStr].includes(i)) {
          row.classList.add("completed");
          btn.innerText = "Completed";
          btn.disabled = true;
        }

        btn.onclick = (e) => {
          e.stopPropagation();
          window.open(s.url, "_blank");
          btn.innerText = "Completed";
          btn.disabled = true;
          row.classList.add("completed");
          saveCompleted(dateStr, i);
        };

        row.append(span);
        row.append(btn);
        linksContainer.append(row);
      });

      card.appendChild(title);
      card.appendChild(linksContainer);
      card.onclick = () => {
        linksContainer.style.display = linksContainer.style.display === "block" ? "none" : "block";
      };

      calendarGrid.appendChild(card);
    }

    updateProgress();
  }

  renderCalendar();
</script>
</body>
</html>
